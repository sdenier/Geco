<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="buildnumber" name="Geco">
	<property file="src/version.prop"/>
	<property file="dev.prop"/>
	<property file="webstart/webstart.prop"/>
	
	<property name="srcdoc.dir" value="doc" />
	<property name="wg.dir" value="${srcdoc.dir}/user/wg" />
	<property name="geco.dir" value="${basedir}"/>
	<property name="sireader.dir" value="${basedir}/../SIReader"/>
	
	<target name="cleanAll" depends="cleanWebgen,cleanBackups" />
	
    <target name="cleanBackups">
		<delete>
			<fileset dir="testData" includes="**/backups/*.zip"/>
			<fileset dir="data" includes="**/backups/*.zip"/>
			<fileset dir="demo" includes="**/backups/*.zip"/>
		</delete>
    </target>

	<target name="cleanWebgen">
		<delete dir="${wg.dir}/out" />
		<delete file="${wg.dir}/webgen.cache" />
		<mkdir dir="${wg.dir}/out/samples" />
    	<copy todir="${wg.dir}/out/samples">
    		<fileset dir="${wg.dir}/src/samples" />
		</copy>
    </target>
	
    <target name="webgen">
    	<exec dir="${wg.dir}" executable="webgen"></exec>
    </target>

	<target name="webgen with analytics">
		<exec dir="${wg.dir}" executable="webgen">
			<env key="analytics_tracking" value="true" />
		</exec>
    </target>
	
	<target name="userHelp" depends="cleanWebgen,webgen">
    	<delete dir="help" />
		<mkdir dir="help" />
    	<copy todir="help">
    		<fileset dir="${wg.dir}/out" />
		</copy>
    </target>
	
	<target name="buildnumber">
		<exec executable="${hg.cmdpath}" outputproperty="hg.buildnumber">
			<arg line="parents --template {rev}" />
		</exec>
		<tstamp />
		<property name="build.number" value="${hg.buildnumber}-${DSTAMP}"/>
		<property name="impl.number" value="${version.num}-${build.number}"/>
		<echo message="${version.num}" />
		<echo message="${build.number}" />
	</target>

	<target name="file_buildnumber" depends="buildnumber">
		<propertyfile file="src/version.prop">
			<entry key="build.num" value="${build.number}"/>
		</propertyfile>	
	</target>
	
	<target name="build_release_jar" depends="file_buildnumber">
		<property name="geco.jarname" value="geco-${version.num}.jar" />
	  	<antcall target="build_jar" />
	</target>

	<target name="build_dev_jar" depends="file_buildnumber">
		<property name="geco.jarname" value="geco-${impl.number}.jar" />
	  	<antcall target="build_jar" />
	</target>
	
    <target name="build_jar">
        <jar destfile="${geco.dir}/${geco.jarname}" filesetmanifest="mergewithoutmain">
            <manifest>
                <attribute name="Main-Class" value="net.geco.GecoLoader"/>
                <attribute name="Class-Path" value="."/>
            	<attribute name="Built-By" value="${dev.username}"/>
            	<attribute name="Built-Date" value="${TODAY}"/> 
               	<attribute name="Implementation-Version" value="${impl.number}"/>
            </manifest>
            <fileset dir="${geco.dir}/bin" excludes="test/,version.prop"/>
            <fileset file="${geco.dir}/src/version.prop"/>
            <fileset file="${geco.dir}/lib/SIReader.jar"/>
        	<fileset file="${geco.dir}/lib/icu4j-charsetdetector-4_4_2.jar"/>
        </jar>
    </target>
	
    <target name="build_distrib" depends="build_release_jar,userHelp">
    	<echo message="${geco.jarname}" />
    	<zip destfile="${geco.dir}/geco-${version.num}.zip">
    		<fileset file="${geco.dir}/${geco.jarname}"/>
    		<fileset file="${geco.dir}/README.md"/>
    		<fileset dir="${geco.dir}" includes="help/"/>
    		<fileset dir="${geco.dir}" includes="licenses/"/>
    		<fileset dir="${geco.dir}" includes="data/modeles/"/>
    	</zip>
	</target>

	<target name="build_demo" depends="cleanBackups,build_release_jar,userHelp">
		<delete>
			<fileset dir="demo" includes="**/backups/*.zip"/>
			<fileset dir="demo" includes="**/*.log"/>
		</delete>
    	<zip destfile="${geco.dir}/geco-${version.num}_demo.zip">
    		<fileset file="${geco.dir}/${geco.jarname}"/>
        	<fileset file="${geco.dir}/README.md"/>
    		<fileset dir="${geco.dir}" includes="help/"/>
    		<fileset dir="${geco.dir}" includes="licenses/"/>
    		<fileset dir="${geco.dir}" includes="data/modeles/"/>
    		<fileset dir="${geco.dir}" includes="demo/"/>
    	</zip>
	</target>	

    <target name="build_livejar" depends="buildnumber">
        <jar destfile="${geco.dir}/livegeco-${build.number}.jar" filesetmanifest="mergewithoutmain">
            <manifest>
                <attribute name="Main-Class" value="net.geco.live.GecoLive"/>
                <attribute name="Class-Path" value="."/>
            	<attribute name="Built-By" value="${dev.username}"/>
            	<attribute name="Built-Date" value="${TODAY}"/> 
               	<attribute name="Implementation-Version" value="${impl.number}"/>
            </manifest>
            <fileset dir="${geco.dir}/bin" excludes="test/"/>
        </jar>
    </target>

    <target name="build_webstart" depends="buildnumber">
        <jar destfile="${geco.dir}/webstart/gecows.jar" filesetmanifest="mergewithoutmain">
            <manifest>
                <attribute name="Main-Class" value="net.geco.live.GecoWebStart"/>
                <attribute name="Class-Path" value="."/>
            	<attribute name="Built-By" value="${dev.username}"/>
            	<attribute name="Built-Date" value="${TODAY}"/> 
               	<attribute name="Implementation-Version" value="${impl.number}"/>
            </manifest>
            <fileset dir="${geco.dir}/bin" excludes="test/"/>
            <fileset dir="${webstart.data}"/>
        </jar>
    </target>
	
	<target name="build_SIReaderDev">
		<ant dir="${sireader.dir}" target="build_devjar" />
		<copy file="${sireader.dir}/SIReaderDev.jar" tofile="${geco.dir}/lib/SIReaderDev.jar" />
	</target>

	<target name="build_SIReader">
		<ant dir="${sireader.dir}" target="build_jar" />
		<copy file="${sireader.dir}/SIReader.jar" tofile="${geco.dir}/lib/SIReader.jar" />
	</target>

</project>
